# 技術要件定義書（動物×政治情報アカウント運営・自動化）

- 文書名: 技術要件定義書.md
- 版: v0.2
- 作成日: 2026-01-20
- 準拠: 要件定義書 v0.1

---

## 1. システムアーキテクチャ

### 1.1 全体構成
本システムは Google Apps Script (GAS) をコアランタイムとし、Google Workspace (Sheets, Drive) をデータベースおよびストレージとして利用するサーバーレスアーキテクチャを採用する。

```mermaid
graph TD
    subgraph External[外部リソース]
        Web[RSS / Web Sites]
        Gemini[Gemini API]
        Genspark[Genspark (手動)]
    end

    subgraph GAS[Google Apps Script]
        Trigger[Time/Edit Triggers]
        Controller[Main Controller]
        Service[Business Logic Services]
        Repo[Sheet Repositories]
    end

    subgraph Storage[Google Workspace]
        Sheet[Google Sheets (DB)]
        Drive[Google Drive (Output)]
    end

    Web -->|Fetch| Controller
    Controller -->|Use| Service
    Service -->|Read/Write| Repo
    Repo -->|CRUD| Sheet
    Service -->|API Call| Gemini
    Service -->|Save MD| Drive
    Trigger -->|Invoke| Controller
```

### 1.2 技術スタック

| カテゴリ | 技術・ツール | 選定理由・詳細 |
| :--- | :--- | :--- |
| **Runtime** | Google Apps Script (V8) | Google Workspaceとの親和性、サーバー管理不要、無料枠の活用。 |
| **Language** | JavaScript (ES6+) | GAS標準のランタイムを使用。型定義はJSDocで行う。 |
| **Deploy** | GAS GitHub Extension | Chrome拡張機能を用いて、GASエディタから直接GitHubリポジトリをPull/Pushする。 |
| **AI API** | Google Gemini API | 
| - *Screening* | **Gemini 3 Flash** | 大量のリクエスト（RSSフィード等）を高速・低コストで処理するため。 |
| - *Generation* | **Gemini 3 Pro** | 高品質な台本生成、深い推論が必要なファクトチェックのため。 |
| **Database** | Google Sheets | 要件定義に従い、RDB代わりのデータストアとして利用。 |
| **Storage** | Google Drive | Markdownファイル、生成された素材の格納先。 |
| **Library** | Cheerio (GAS版) | スクレイピング時のDOM解析用（必要な場合）。基本は正規表現や`XmlService`で軽量化を図る。 |

---

## 2. 実装詳細方針

### 2.1 ディレクトリ構造

`src/` 配下に機能ごとに分割して配置する。GASプロジェクト上では拡張機能によりフォルダ階層が認識されるか、ファイル名の一部として扱われる。

```
src/
├── config/           # 定数、設定値
│   └── Config.js     # モデル名、プロンプトバージョン、フォルダID等
├── models/           # データ型定義 (JSDoc)
│   ├── Item.js
│   └── Topic.js
├── services/         # ビジネスロジック
│   ├── FetchService.gs       # RSS/Web取得
│   ├── GeminiService.gs      # Gemini API通信ラップ
│   ├── ScreeningService.gs   # AIスクリーニング
│   ├── DeepResearchService.gs # 深掘り調査（多面的視点・信頼性評価）
│   ├── PrimarySourceService.gs # 一次ソース収集
│   ├── TimelineService.gs    # 時系列分析
│   ├── FactCheckService.gs   # ファクトチェック
│   ├── TopicService.gs       # テーマ生成（Deep Research連携）
│   ├── StakeholderService.gs # ステークホルダー分析
│   ├── ContentService.gs     # コンテンツ生成
│   ├── ProjectManager.gs     # プロジェクトスプシ管理
│   └── SourceDiscoveryService.gs # 収集先自動開拓
├── utils/            # ユーティリティ
│   ├── ReliabilityEvaluator.gs # 信頼性スコアリング
│   └── TriggerManager.gs     # トリガー管理
├── repositories/     # Sheetsアクセス
│   ├── SheetBase.js          # 共通処理 (Headers処理など)
│   ├── IntakeQueueRepo.js
│   └── ...
├── utils/            # ユーティリティ
│   ├── TextUtils.js
│   └── DateUtils.js
└── main.js           # エントリーポイント (トリガーから呼ばれる関数群)
```

### 2.2 データアクセス (Repository Pattern)

Google SheetsへのアクセスはRepository層で抽象化し、ビジネスロジック内に `SpreadsheetApp` の呼び出しを散在させない。

- **行とオブジェクトの変換**: ヘッダー行を読み取り、カラム名とオブジェクトのプロパティを動的にマッピングする。
- **一括処理**: `getValues()` / `setValues()` を活用し、1行ごとのAPI呼び出しを避ける。
- **排他制御**: `LockService` を使用し、複数トリガーによる競合書き込みを防ぐ。

### 2.3 Gemini API 連携

- **通信方式**: `UrlFetchApp` を使用して `POST` リクエストを送信。
- **認証**: Script Properties に保存した `GEMINI_API_KEY` を使用。
- **Structured Output**: `response_mime_type: "application/json"` を指定し、確実なJSONレスポンスを得る。

### 2.4 トリガー設計

GASの制限（実行時間6分）を考慮した設計とする。

1.  **Dispatcher Pattern**:
    - 時間トリガーは直接重い処理を行わず、まず `JobQueue` シートを確認するか、処理対象を特定して小分けにして処理を実行する。
    - または、`main` 関数内で `startTime` を記録し、5分を経過しそうなら処理を中断して次回のトリガーに任せる（Time-boxing）。

2.  **編集トリガーの軽量化**:
    - `onEdit` は単純なステータス変更検知のみを行い、実際の処理は行わない（Installable Triggerを使用）。
    - 編集トリガーは `JobQueue` へのタスク登録を主目的とするのが安全。

---

## 3. 非機能要件への対応

### 3.1 エラーハンドリング
- APIエラー（Geminiのレート制限など）は指数バックオフ（Exponential Backoff）でリトライする。
- 致命的なエラーは `RunLogs` シートに記録し、管理者にメール通知（オプション）を行う。

### 3.2 拡張性
- プロンプトはコード内に埋め込まず、`Config` クラスまたは専用の `Prompts` クラス、あるいは外部スプレッドシート/ドキュメントから読み込む形も検討する。

### 3.3 セキュリティ
- APIキーは `.clasp.json` やコードに含めず、GASの「スクリプトプロパティ」に手動設定する。
- ソースコード上の機密情報排除を徹底する。

---

## 4. 開発・デプロイフロー

1.  **環境準備**: Chrome拡張機能「Google Apps Script GitHub アシスタント」等をインストール。
2.  **Pull**: GASエディタ上でリポジトリからコードを取得。
3.  **開発**: GASエディタ上でコードを編集、またはローカルで編集してGitHubへPush -> GASでPull。
4.  **Push**: GASエディタ上で修正した内容をGitHubへPush（オプション）。

## 5. 次のステップ（実装フェーズ）

1.  **環境構築**:
    - GASプロジェクト作成
    - Chrome拡張機能のセットアップ
    - GitHubリポジトリとの連携
2.  **ベース実装**:
    - `config` 設定
    - `SheetBase` リポジトリの実装
    - `GeminiService` の疎通確認
3.  **機能実装**:
    - FR-1 (収集) 〜 FR-8 (出力) を順次実装。
