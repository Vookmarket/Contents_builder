# 要件定義書（動物×政治情報アカウント運営・自動化）

- 文書名: 要件定義書.md
- 版: v0.1（ドラフト）
- 作成日: 2026-01-20（Asia/Tokyo）
- 対象媒体: YouTube（ショート/長尺）・note
- 想定技術: Google Drive / Google Sheets（スプシ）/ Google Apps Script（GAS：時間トリガー・編集トリガー・トリガー管理）/ Gemini API / Genspark

---

## 1. 背景・目的

### 1.1 背景
動物に関する社会・経済・政治情報は、制度改正、行政運用、産業構造、国際情勢などの影響で変動しやすい。また、二次情報・切り抜き・誤引用により、誤情報が流通しやすい。

### 1.2 目的
以下を「継続運用できる形」で仕組み化し、制作コストとリスクを下げる。

- **最新情報のキャッチアップ**を半自動化（収集→スクリーニング→一次ソース→テーマ化→ステークホルダー→コンテンツ化）
- **特定テーマの網羅的説明**を、再利用可能な「知識パッケージ」として整備（歴史的経緯・時系列・立場比較・制度/法律の骨子）
- 出力を **YouTubeショート / YouTube長尺 / note** に最適化し、原稿・アウトライン・制作プロンプトを生成
- 生成物は参照URLと一次/二次区分を付し、**ファクト**と**解釈/意見**を分離する

---

## 2. スコープ

### 2.1 対象（In Scope）
- インターネット上の情報収集（主にRSS・公式発表・公開ページ）
- スクリーニング（動物関連度・政治/制度関連度・重要度・誤情報リスク等の付与）
- 一次ソース候補の収集・整理（法令、統計、議事録、白書、団体声明、原論文等）
- テーマ案の生成、ステークホルダー整理
- YouTubeショート/長尺/note向けの台本・アウトライン・プロンプト生成
- 収集・生成物のDrive保存、Sheetsでのキュー管理、実行ログ

### 2.2 対象外（Out of Scope）
- YouTubeへの自動投稿、noteへの自動公開（将来拡張として検討）
- 有料データベースやクローズドなメディアの無断取得
- 著作物の全文複製（引用は最小限＋リンク中心）
- リアルタイム討論やライブ配信の自動運用

### 2.3 前提
- Google Workspaceを主運用基盤とする
- 自動化の中核はGAS（Apps Script）とし、外部APIはHTTPで呼び出す
- Gemini APIはAPIキー方式で利用（キーの安全管理を必須）
- Gensparkは「生成を実行する場」として利用し、当面は **Genspark向けプロンプト生成**を自動化範囲に含める

---

## 3. 成果物（自動生成物）

### 3.1 Evidence Pack（根拠パッケージ）
- 収集した候補情報の一覧
- 一次ソース候補URL一覧
- Claims（主張）→Evidence（根拠）→確度の対応表
- ステークホルダー一覧（立場/利害/根拠URL）

### 3.2 Content Pack（コンテンツパッケージ）
- YouTubeショート台本（15–60秒）
- YouTube長尺台本（10–20分）＋スライド構成案
- note下書き（MarkdownまたはDocs）
- Genspark向けプロンプト集（Slides/動画素材/図解 等）

### 3.3 運用ダッシュボード
- Google Sheets（キュー、トピック、根拠、ログ）
- Drive（トピック単位のフォルダ構成）

---

## 4. システム概要

### 4.1 構成要素
- Google Sheets：運用DB（収集元、候補、トピック、根拠、生成物リンク、ログ）
- Google Drive：成果物保管（Markdown、資料リンク、生成物）
- GAS：定期収集、整形、保存、**時間トリガー/編集トリガー**、**トリガー管理（追加・削除・再構築）**、Sheetsメニュー操作
- Gemini API：分類、要約、抽出、下書き生成
- Genspark：スライド/素材生成（当面はプロンプト投入を前提）

### 4.2 処理フロー（最新情報）
1. 収集（RSS/Web）→ IntakeQueueへ保存
2. Geminiでスクリーニング（スコア・タグ・要約）
3. 一次ソース候補の抽出・探索 → EvidenceIndexへ保存
4. テーマ案生成 → TopicBacklogへ登録
5. ステークホルダー整理 → StakeholderMapへ保存
6. 媒体別原稿/プロンプト生成 → Driveへ出力、Outputs更新

---

## 5. データ設計（Sheets）

### 5.1 シート一覧（テーブル）
1) `SourceRegistry`（収集元）
- source_id（PK）
- name（表示名）
- type（RSS/Web/API/Manual）
- url
- fetch_freq（例：daily/3x_daily/hourly）
- lang（ja/en）
- reliability_base（1–5）
- enabled（TRUE/FALSE）
- memo

2) `IntakeQueue`（収集候補）
- item_id（PK）
- fetched_at（ISO日時）
- source_id
- title
- url
- published_at（任意）
- snippet（本文抜粋）
- dedupe_key（正規化URLやハッシュ）
- status（new/screened/promoted/ignored/error）
- notes

3) `Screening`（スクリーニング結果）
- item_id（FK）
- animal_score（0–5）
- policy_score（0–5）
- urgency（0–5）
- japan_relevance（0–5）
- misinformation_risk（low/med/high）
- tags（CSV）
- summary_30s
- key_points（箇条書きテキスト）
- model_meta（モデル/温度/プロンプト版）

4) `TopicBacklog`（テーマ）
- topic_id（PK）
- created_at
- title_working
- angle（速報/解説/論点整理/歴史）
- target_media（short/long/note：複数可）
- priority（1–5）
- status（draft/researching/writing/review/ready/published/archived）
- lead_item_ids（関連item_id一覧）

5) `EvidenceIndex`（根拠）
- topic_id（FK）
- claim_id（PK or topic内連番）
- claim_text（主張）
- evidence_url
- evidence_type（law/statistics/minutes/paper/statement/news/other）
- primary_flag（TRUE/FALSE）
- confidence（A/B/C）
- evidence_notes

6) `StakeholderMap`（ステークホルダー）
- topic_id（FK）
- stakeholder_name
- category（行政/政党/業界/研究・獣医/NGO/市民/国際/その他）
- interest（利害・関心）
- stance（想定立場：賛/反/中立/分裂 など）
- reference_url（根拠）

7) `Outputs`（生成物リンク）
- topic_id（FK）
- drive_folder_url
- md_evidence_url
- md_short_url
- md_long_url
- md_note_url
- md_genspark_prompt_url

8) `RunLogs`（実行ログ）
- run_id（PK）
- started_at / ended_at
- job_type（fetch/screen/evidence/write）
- items_in / items_out
- errors（概要）
- log_url（任意：ログファイル）

9) `TriggerRegistry`（トリガー定義/管理）
- trigger_key（PK：任意の識別子）
- trigger_type（time/onEdit/onChange/onOpen など）
- handler_function（実行する関数名）
- schedule（timeの場合：cron相当の説明、例：daily 07:30）
- target_sheet（編集トリガー対象シート名：任意）
- condition（例："TopicBacklog.status == 'ready'" のような条件文字列/JSON）
- enabled（TRUE/FALSE）
- installed_trigger_id（GAS側トリガーID：同期用）
- last_installed_at
- memo

（任意）10) `JobQueue`（重い処理のキュー：推奨）
- job_id（PK）
- created_at
- job_type（fetch/screen/evidence/write/regen など）
- payload_json（対象item_id/topic_id等）
- status（queued/running/done/error）
- attempts
- last_error


---

## 6. 出力仕様（Drive / Markdown）

### 6.1 フォルダ命名
- 形式：`YYYY-MM-DD__topic-<slug>`
- 例：`2026-01-20__topic-animal-welfare-amendment`

### 6.2 ファイル構成（必須）
- `00_intake.md`（収集一覧・要約）
- `01_primary_sources.md`（一次資料リンク集＋要点）
- `02_claims_check.md`（Claims→Evidence→確度）
- `03_stakeholders.md`（Stakeholder一覧＋根拠）
- `10_shorts_script.md`（ショート台本＋テロップ案）
- `11_long_script.md`（長尺台本＋章立て＋スライド構成）
- `12_note_draft.md`（note下書き）
- `20_genspark_prompts.md`（Genspark用プロンプト集）

### 6.3 各Markdownの共通メタデータ（先頭に付与）
```yaml
---
generated_at: "2026-01-20T19:30:00+09:00"
topic_id: "T-000123"
source_items: ["I-000991", "I-000992"]
model:
  provider: "gemini"
  model_name: "<model-name>"
  prompt_version: "p-2026-01-20-01"
---
```

### 6.4 引用・根拠ルール
- 原則：**リンク中心**（著作物の長文転載は禁止）
- “事実”は `EvidenceIndex` に必ず紐付ける
- “推測/論評”は明示（例：`【解釈】` `【論評】` ラベル）

---

## 7. 機能要件（Functional Requirements）

### FR-1 情報収集（スクリーニング前）
- 入力：`SourceRegistry`（enabled=TRUE）
- 処理：RSS/API優先。Webの場合はHTML取得→タイトル/日付/本文抜粋/URLを抽出
- 重複排除：`dedupe_key`（正規化URL＋タイトル類似等）
- 出力：`IntakeQueue`に追加、`RunLogs`更新

### FR-2 自動スクリーニング（関連度/重要度付与）
- 入力：`IntakeQueue.status=new`
- 処理：Geminiで分類・要約・タグ付け
- 閾値例：`animal_score + policy_score >= 7` かつ `misinformation_risk != high` をpromote候補
- 出力：`Screening`更新、`IntakeQueue.status=screened/promoted/ignored`

### FR-3 一次ソース収集・深掘り調査（Deep Research）
- 入力：`IntakeQueue.status=promoted`
- 処理：
  - **一次ソース収集**: 政府機関・法令・統計データの直接取得
  - **多面的視点収集**: 推進派・反対派・中立・一次ソースの4視点から収集し、バイアスを判定
  - **信頼性評価**: 全記事を0-100点でスコアリング
  - **ファクトチェック**: 元記事の数値を一次ソースと照合（verified/conflicting/unverified）
  - **時系列分析**: 過去記事と法改正履歴から「なぜ今？」という背景イベントを抽出
- 出力：プロジェクト専用スプレッドシート (`01_Research`, `04_FactCheck`, `05_Timeline`) の生成

### FR-4 発信テーマ生成（高度化）
- 入力：Deep Research結果 (`01_Research`, `05_Timeline`)
- 処理：
  - 時系列情報から「文脈」を読み取り、解説の切り口（Angle）を提案
  - 対立構造を踏まえた「論点整理」型の企画
- 出力：`TopicBacklog`追加

### FR-5 ステークホルダー抽出・マッピング（高度化）
- 入力：Deep Research結果 (`01_Research` の bias_indicator)
- 処理：記事のバイアス情報から、各アクターのスタンス（賛成/反対）や背後にある利害を詳細に分析
- 出力：`StakeholderMap`更新

### FR-6 媒体別コンテンツ生成（高度化）
- 入力：topic + Verified Facts (`04_FactCheck`) + Timeline (`05_Timeline`)
- 共通要件：検証済み数値の優先利用、参照URL一覧、一次/二次区分、ファクト/解釈の分離
- 出力：プロジェクトシート (`03_Drafts`) への保存

**FR-6a YouTubeショート**
- 形式：15–60秒
- 生成物：台本（口語）、テロップ案、サムネ文言案、ショット指示（簡易）
- 出力：`10_shorts_script.md`

**FR-6b YouTube長尺**
- 形式：10–20分
- 生成物：章立て、ナレーション台本、スライド構成（枚数・各スライド要点・図表案）、注意点（断定回避）
- 出力：`11_long_script.md`

**FR-6c note**
- 形式：テキスト（Markdown/Docs）
- 生成物：導入/背景/時系列/立場比較/論点/まとめ、脚注風リンク集
- 出力：`12_note_draft.md`

### FR-7 Genspark用プロンプト生成
- 入力：short/long/noteの目的別要件
- 出力：`20_genspark_prompts.md`
- 目的別テンプレ例：
  - Slides生成（長尺向け）
  - ショート用の動画素材生成（テロップ・B-roll・構図）
  - 図解・比較表生成（note/長尺向け）

### FR-8 パッケージ化・リンク登録
- 処理：トピック単位フォルダ生成、Markdown出力、`Outputs`にURLを集約
- 出力：`Outputs`更新、`RunLogs`更新

### FR-9 トリガー管理（追加・削除・再インストール）
- 目的：運用しながら収集頻度や編集連動を変更できるよう、トリガーをコードで一括管理する
- 入力：`TriggerRegistry.enabled=TRUE` の定義
- 処理：
  - `installTriggers()`：`TriggerRegistry`を読み、時間トリガー/編集トリガー（インストール型）を作成し、`installed_trigger_id`に反映
  - `removeTriggers()`：既存トリガーを条件（handler名/種別/trigger_key）で削除
  - `resetTriggers()`：全削除→再インストール
  - `syncTriggers()`：プロジェクト内の現状トリガー一覧をSheetへ出力（監査用）
- 出力：`TriggerRegistry`更新、`RunLogs`更新

（推奨）FR-9a 編集トリガーは“軽い処理”に限定
- onEdit/onChangeは、基本的に "状態変更を検知→JobQueueへ積む" までに留める
- 重い処理（Gemini呼び出し、Web取得、Markdown生成）は時間主導トリガー（ワーカー）で`JobQueue`を消化する


---

## 8. AI要件（Gemini）

### 8.1 スクリーニング出力（JSON）
Geminiからの出力は、GASで機械処理できるよう **JSON固定** とする。

```json
{
  "animal_score": 0,
  "policy_score": 0,
  "urgency": 0,
  "japan_relevance": 0,
  "misinformation_risk": "low",
  "tags": [""],
  "summary_30s": "",
  "key_points": [""],
  "claims": [
    {"claim_text": "", "claim_type": "fact|interpretation", "support_needed": true}
  ],
  "recommended_action": "ignore|monitor|promote",
  "notes": ""
}
```

### 8.2 生成品質ガードレール
- 断定回避：根拠が薄い場合は「〜と報じられている」「一次資料では〜」を優先
- 危険な誤情報の兆候（極端な煽り、根拠なしの数字、出典不明の引用）→ `misinformation_risk=high`
- 価値判断を含む箇所は `【解釈】` `【論評】` を付ける

### 8.3 プロンプト管理
- プロンプトは版管理（`prompt_version`）し、Outputsのメタデータに埋め込む
- 主要テンプレはGAS内定数＋Sheetsに外出し可能（運用で調整しやすく）

---

## 9. 操作要件（ユーザー操作）

### 9.1 Sheetsカスタムメニュー（必須）
- 「今すぐ収集を実行」
- 「選択itemを深掘り（一次ソース収集）」
- 「選択topicでショート生成」
- 「選択topicで長尺/Note生成」
- 「ステークホルダー再生成」

### 9.2 手動入力
- 任意のURLを貼り付け→単独でFR-2〜FR-7相当を実行できる導線を用意（Manualモード）

---

## 10. 自動実行（トリガー）

このシステムは **GASの時間主導トリガー** と **編集トリガー（インストール型）** を併用し、さらに **トリガーの追加・削除・再構築を行う管理スクリプト** で運用しやすくする。

### 10.1 時間主導トリガー（Time-driven：定期実行）
- 07:30 / 12:30 / 19:30：FR-1→FR-2→（promotedのみ）FR-3→FR-4→FR-6a（ショート案まで）
- 週次（例：日曜20:00）：優先度上位topicに対してFR-6b/FR-6cを実行
- （推奨）ワーカー：一定間隔（例：15分ごと）で`JobQueue`を消化（重い処理を集約）

### 10.2 編集トリガー（onEdit / onChange：編集連動）
- 目的：編集者の操作（ステータス変更等）を起点に、後続処理を自動で回す
- 対象例：
  - `SourceRegistry.enabled` の変更 → 次回収集対象へ反映
  - `IntakeQueue.status` を `promoted` に変更 → 一次ソース収集（FR-3）をキュー投入
  - `TopicBacklog.status` を `researching/writing/review/ready` 等に変更 → 必要な生成（FR-5/FR-6/FR-7）をキュー投入
- 実装方針：
  - Drive/UrlFetch/Gemini呼び出し等の権限が必要な処理があるため、**シンプルトリガーではなくインストール型トリガー** を前提
  - onEdit/onChange内では「条件判定→`JobQueue`へ積む」までに留め、重い処理は時間主導トリガーで実行（タイムアウト/クォータ対策）

### 10.3 トリガー管理（追加・削除・再構築）
- `TriggerRegistry` を“トリガーの単一の正”として扱い、コードで同期する
- 必須ユーティリティ（GAS関数）
  - `installTriggers()`：`TriggerRegistry`に基づきトリガーを作成
  - `removeTriggers()`：条件指定でトリガーを削除
  - `resetTriggers()`：全削除→再インストール
  - `syncTriggers()`：現状トリガーをSheetへ出力（監査・可視化）
- 運用：初回セットアップ/運用変更時は、Sheetsメニューから上記を実行できるようにする

### 10.4 実行制御
- 同時実行の衝突回避（LockService等）
- 失敗時リトライ（回数・間隔はパラメータ）
- クォータ超過時の縮退：要約のみ/件数制限
- 冪等性：同一topic/itemに対する二重生成を避ける（status管理、ジョブID、dedupe）

---

## 11. 非機能要件（Non-Functional Requirements）

### 11.1 正確性・追跡可能性
- すべての生成物に参照URL一覧を付与
- 重要トピックは一次資料が最低1本ない場合、速報以上の扱いをしない（運用ルールとしても明文化）

### 11.2 セキュリティ
- APIキーはスクリプトプロパティ等で管理し、共有範囲を最小化
- Driveフォルダは原則非公開（公開用は別フォルダに移す運用）

### 11.3 コスト/レート制御
- 収集頻度、処理件数上限、Gemini呼び出し回数をパラメータ化
- 長文は段階処理（まず要約→必要なものだけ深掘り）

### 11.4 可用性・運用
- `RunLogs`で実行状況を可視化
- エラー通知は「重要な失敗のみ」（通知過多を避ける）

---

## 12. 外部連携要件

### 12.1 Gemini API
- GASからHTTPで呼び出す（APIキー）
- 主要用途：分類、要約、抽出、台本生成

### 12.2 Genspark
- 当面は「プロンプト生成→手動投入」を前提
- 将来、連携API等が提供される場合は自動投入を検討

---

## 13. 運用ルール（編集方針）

- 速報は「わかっている事実」中心、論評は分離
- 政治的対立を煽る表現を避け、ステークホルダーの利害と制度構造に焦点を当てる
- 不確実な情報は扱わない/保留する判断を自動化に組み込む（misinformation_risk）

---

## 14. 受入基準（Acceptance Criteria）

1. `SourceRegistry`に10件以上登録し、定期収集で`IntakeQueue`に追加できる
2. スクリーニングがJSON固定で返り、`Screening`が自動更新される
3. promoted itemから一次ソース候補が抽出され、`01_primary_sources.md`が生成される
4. 1つのtopicについて、以下がDriveに自動生成され、`Outputs`にURLが揃う
   - Evidence Pack（00〜03）
   - Content Pack（10〜12、20）
5. 生成物に参照URL一覧と一次/二次区分が含まれる
6. 実行ログが`RunLogs`に残り、失敗時の原因が追える

7. `TriggerRegistry`に定義した時間/編集トリガーが`installTriggers()`で作成でき、`removeTriggers()`で削除でき、同期結果（installed_trigger_id等）がSheetに反映される

---

## 15. ロードマップ（拡張案）

- v0.2：官公庁・法令・統計の探索ルール強化、Claims/Evidenceのスコアリング改善
- v0.3：長尺のスライド構成の品質向上（図表生成、比較表テンプレ）
- v0.4：公開フロー連携（YouTube/noteの半自動投稿、公開前チェックリスト自動生成）

---

## 付録A. 推奨パラメータ（初期値例）

- promoted閾値：`animal_score + policy_score >= 7`
- misinformation_risk：`high`は自動生成対象外（monitorのみ）
- 1回の処理上限：収集50件 / スクリーニング50件 / 深掘り10件
- タグ候補：感染症、畜産、野生動物、動物福祉、実験動物、ペット流通、国際条約、行政運用、地方自治
